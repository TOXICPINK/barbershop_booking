<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>رزرو نوبت</title>
  <link rel="stylesheet" href="/static/app.css">
</head>
<body>
  <div class="container">
    <h1>رزرو نوبت</h1>

    <div class="grid">
      <div>
        <label>سرویس</label>
        <select id="service"></select>
      </div>
      <div>
        <label>آرایشگر</label>
        <select id="barber"></select>
      </div>
      <div>
        <label>تاریخ</label>
        <input id="date" type="date">
      </div>
      <div>
        <button id="loadSlots">نمایش زمان‌های خالی</button>
      </div>
    </div>

    <div id="slots" class="slots"></div>

    <div id="bookingForm" class="booking-form hidden">
      <h3>تکمیل اطلاعات</h3>
      <label>نام:</label>
      <input id="custName" type="text" placeholder="نام شما">
      <label>تلفن:</label>
      <input id="custPhone" type="text" placeholder="مثلاً 09...">
      <button id="confirmBtn">تأیید رزرو</button>
    </div>
  </div>

  <script>
  async function loadServices() {
    const res = await fetch('/services/');
    const data = await res.json();
    const sel = document.getElementById('service');
    sel.innerHTML = data.map(s => `<option value="${s.id}" data-duration="${s.duration}">${s.title} - ${s.price.toLocaleString()} تومان</option>`).join('');
  }
  async function loadBarbers() {
    const res = await fetch('/barbers/');
    const data = await res.json();
    const sel = document.getElementById('barber');
    sel.innerHTML = data.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
  }
  function toISO(date, hhmm) {
    const [h,m] = hhmm.split(':').map(Number);
    const d = new Date(date + 'T00:00:00');
    d.setHours(h, m, 0, 0);
    return d.toISOString();
  }
  document.getElementById('loadSlots').addEventListener('click', async () => {
    const serviceSel = document.getElementById('service');
    const barberId = document.getElementById('barber').value;
    const date = document.getElementById('date').value;
    const duration = serviceSel.options[serviceSel.selectedIndex].dataset.duration;
    if (!barberId || !date) { alert('آرایشگر و تاریخ را انتخاب کنید.'); return; }
    const res = await fetch(`/availability/?barber_id=${barberId}&date=${date}&service_duration=${duration}`);
    const data = await res.json();
    const holder = document.getElementById('slots');
    holder.innerHTML = data.slots.map(s => `<button class="slot-btn" data-time="${s}">${s}</button>`).join('');
    document.querySelectorAll('.slot-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.getElementById('bookingForm').classList.remove('hidden');
        document.getElementById('bookingForm').dataset.time = btn.dataset.time;
      });
    });
  });
  document.getElementById('confirmBtn').addEventListener('click', async () => {
    const serviceId = document.getElementById('service').value;
    const barberId = document.getElementById('barber').value;
    const date = document.getElementById('date').value;
    const time = document.getElementById('bookingForm').dataset.time;
    const name = document.getElementById('custName').value;
    const phone = document.getElementById('custPhone').value;
    if (!time || !name) { alert('زمان و نام را وارد کنید.'); return; }
    const start_iso = toISO(date, time);
    const payload = { customer_name: name, customer_phone: phone, service_id: Number(serviceId), barber_id: Number(barberId), start_datetime: start_iso };
    const res = await fetch('/bookings/', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
    if (res.ok) {
      alert('رزرو با موفقیت ثبت شد.');
      document.getElementById('bookingForm').classList.add('hidden');
    } else {
      const err = await res.json();
      alert('خطا: ' + (err.detail || 'امکان رزرو این زمان وجود ندارد.'));
    }
  });
  loadServices();
  loadBarbers();
  </script>
</body>
</html>
